<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLUX.2 Image Generation - All Workflows</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #0f1419;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #2d3748;
        }

        h1 {
            color: #e2e8f0;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #a0aec0;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .config-section {
            background: #1a202c;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #2d3748;
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #2d3748;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #a0aec0;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .workflow-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .workflow-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #2d3748;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #1a202c;
            color: #e2e8f0;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .inline-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .seed-group {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .seed-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .seed-group button {
            padding: 12px 20px;
            font-size: 14px;
            margin-top: 0;
            width: auto;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
            border: 1px solid;
        }

        .status.info {
            background: #1e3a5f;
            color: #63b3ed;
            border-color: #2c5282;
            display: block;
        }

        .status.success {
            background: #1e3d2f;
            color: #68d391;
            border-color: #2f855a;
            display: block;
        }

        .status.error {
            background: #3d1e1e;
            color: #fc8181;
            border-color: #c53030;
            display: block;
        }

        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .result {
            display: none;
        }

        .result.show {
            display: block;
        }

        .result img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .metadata {
            background: #1a202c;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: #a0aec0;
            border: 1px solid #2d3748;
        }

        .metadata p {
            margin: 5px 0;
        }

        .metadata strong {
            color: #e2e8f0;
        }

        .request-display {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .request-display pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .help-text {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® FLUX.2 Image Generation</h1>
        <p class="subtitle">All workflows: Text-to-Image, Image-to-Image, Multi-Reference</p>

        <!-- Configuration Section -->
        <div class="config-section">
            <h3>‚öôÔ∏è API Configuration</h3>
            <div class="form-group">
                <label for="apiKey">RunPod API Key</label>
                <input type="text" id="apiKey" placeholder="Your RunPod API key" required>
                <div class="help-text">Get from RunPod dashboard ‚Üí Settings ‚Üí API Keys</div>
            </div>
            <div class="form-group">
                <label for="endpointId">Endpoint ID</label>
                <input type="text" id="endpointId" placeholder="zjw2i2yqjn0mny" required>
                <div class="help-text">Just the endpoint ID (e.g., zjw2i2yqjn0mny)</div>
            </div>
            <button onclick="testConnection()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-top: 0;">
                üîç Test Connection
            </button>
        </div>

        <!-- Workflow Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchWorkflow('txt2img')">üìù Text-to-Image</button>
            <button class="tab" onclick="switchWorkflow('img2img')">üñºÔ∏è Image-to-Image</button>
            <button class="tab" onclick="switchWorkflow('multi')">üé≠ Multi-Reference</button>
        </div>

        <!-- Text-to-Image Workflow -->
        <div id="txt2img" class="workflow-content active">
            <div class="config-section">
                <h3>üìù Text-to-Image</h3>
                <div class="form-group">
                    <label for="prompt-txt2img">Prompt</label>
                    <textarea id="prompt-txt2img" placeholder="Describe the image you want to generate..." required>A majestic mountain peak at sunset with dramatic clouds, photorealistic, 8k, highly detailed</textarea>
                </div>

                <div class="inline-group">
                    <div class="form-group">
                        <label for="width-txt2img">Width</label>
                        <input type="number" id="width-txt2img" value="1024" min="256" max="2048" step="8">
                    </div>
                    <div class="form-group">
                        <label for="height-txt2img">Height</label>
                        <input type="number" id="height-txt2img" value="1024" min="256" max="2048" step="8">
                    </div>
                    <div class="form-group">
                        <label for="steps-txt2img">Steps</label>
                        <input type="number" id="steps-txt2img" value="28" min="1" max="100">
                        <div class="help-text">28 recommended</div>
                    </div>
                    <div class="form-group">
                        <label for="guidance-txt2img">Guidance</label>
                        <input type="number" id="guidance-txt2img" value="4.0" min="0" max="20" step="0.1">
                        <div class="help-text">4.0 recommended</div>
                    </div>
                </div>

                <div class="seed-group">
                    <div class="form-group">
                        <label for="seed-txt2img">Seed</label>
                        <input type="number" id="seed-txt2img" placeholder="Random">
                        <div class="help-text">Leave empty for random</div>
                    </div>
                    <button onclick="randomizeSeed('txt2img')">üé≤ Random</button>
                </div>

                <button onclick="generate('txt2img')">Generate Image</button>
            </div>
        </div>

        <!-- Image-to-Image Workflow -->
        <div id="img2img" class="workflow-content">
            <div class="config-section">
                <h3>üñºÔ∏è Image-to-Image</h3>

                <div class="form-group">
                    <label for="init-image">Initial Image</label>
                    <input type="file" id="init-image" accept="image/*" onchange="previewImage('init-image', 'init-preview')">
                    <img id="init-preview" class="file-preview">
                    <div class="help-text">Upload an image to transform</div>
                </div>

                <div class="form-group">
                    <label for="prompt-img2img">Prompt</label>
                    <textarea id="prompt-img2img" placeholder="Describe how to transform the image..." required>transform this into a watercolor painting style, vibrant colors, artistic</textarea>
                </div>

                <div class="inline-group">
                    <div class="form-group">
                        <label for="width-img2img">Width</label>
                        <input type="number" id="width-img2img" value="1024" min="256" max="2048" step="8">
                    </div>
                    <div class="form-group">
                        <label for="height-img2img">Height</label>
                        <input type="number" id="height-img2img" value="1024" min="256" max="2048" step="8">
                    </div>
                    <div class="form-group">
                        <label for="strength-img2img">Strength</label>
                        <input type="number" id="strength-img2img" value="0.75" min="0" max="1" step="0.05">
                        <div class="help-text">0.5-0.8 typical</div>
                    </div>
                    <div class="form-group">
                        <label for="steps-img2img">Steps</label>
                        <input type="number" id="steps-img2img" value="28" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="guidance-img2img">Guidance</label>
                        <input type="number" id="guidance-img2img" value="3.0" min="0" max="20" step="0.1">
                        <div class="help-text">3.0 for img2img</div>
                    </div>
                </div>

                <div class="seed-group">
                    <div class="form-group">
                        <label for="seed-img2img">Seed</label>
                        <input type="number" id="seed-img2img" placeholder="Random">
                    </div>
                    <button onclick="randomizeSeed('img2img')">üé≤ Random</button>
                </div>

                <button onclick="generate('img2img')">Generate Image</button>
            </div>
        </div>

        <!-- Multi-Reference Workflow -->
        <div id="multi" class="workflow-content">
            <div class="config-section">
                <h3>üé≠ Multi-Reference</h3>

                <div class="form-group">
                    <label for="ref-image-1">Reference Image 1</label>
                    <input type="file" id="ref-image-1" accept="image/*" onchange="previewImage('ref-image-1', 'ref-preview-1')">
                    <img id="ref-preview-1" class="file-preview">
                </div>

                <div class="form-group">
                    <label for="ref-image-2">Reference Image 2</label>
                    <input type="file" id="ref-image-2" accept="image/*" onchange="previewImage('ref-image-2', 'ref-preview-2')">
                    <img id="ref-preview-2" class="file-preview">
                </div>

                <div class="form-group">
                    <label for="ref-image-3">Reference Image 3 (Optional)</label>
                    <input type="file" id="ref-image-3" accept="image/*" onchange="previewImage('ref-image-3', 'ref-preview-3')">
                    <img id="ref-preview-3" class="file-preview">
                </div>

                <div class="form-group">
                    <label for="prompt-multi">Prompt</label>
                    <textarea id="prompt-multi" placeholder="Describe how to combine the styles..." required>blend these artistic styles into a cohesive masterpiece</textarea>
                </div>

                <div class="inline-group">
                    <div class="form-group">
                        <label for="width-multi">Width</label>
                        <input type="number" id="width-multi" value="1024" min="256" max="2048" step="8">
                    </div>
                    <div class="form-group">
                        <label for="height-multi">Height</label>
                        <input type="number" id="height-multi" value="1024" min="256" max="2048" step="8">
                    </div>
                    <div class="form-group">
                        <label for="steps-multi">Steps</label>
                        <input type="number" id="steps-multi" value="28" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="guidance-multi">Guidance</label>
                        <input type="number" id="guidance-multi" value="3.0" min="0" max="20" step="0.1">
                    </div>
                </div>

                <div class="seed-group">
                    <div class="form-group">
                        <label for="seed-multi">Seed</label>
                        <input type="number" id="seed-multi" placeholder="Random">
                    </div>
                    <button onclick="randomizeSeed('multi')">üé≤ Random</button>
                </div>

                <button onclick="generate('multi')">Generate Image</button>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="status"></div>

        <!-- Results -->
        <div class="results-container">
            <!-- Generated Image -->
            <div>
                <div id="result" class="result">
                    <h3>Generated Image</h3>
                    <img id="generatedImage" alt="Generated image">
                    <div class="metadata" id="metadata"></div>
                </div>
            </div>

            <!-- Request Display -->
            <div>
                <div id="request-result" class="result">
                    <h3>Request & Response</h3>
                    <div class="request-display">
                        <pre id="requestDisplay"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentWorkflow = 'txt2img';

        function switchWorkflow(workflow) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.workflow-content').forEach(content => content.classList.remove('active'));
            document.getElementById(workflow).classList.add('active');

            currentWorkflow = workflow;
        }

        function randomizeSeed(workflow) {
            const seed = Math.floor(Math.random() * 2147483647);
            document.getElementById(`seed-${workflow}`).value = seed;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function previewImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function generate(workflow) {
            const resultDiv = document.getElementById('result');
            const requestDiv = document.getElementById('request-result');

            // Get API config
            const endpointId = document.getElementById('endpointId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!endpointId || !apiKey) {
                showStatus('‚ùå Please configure endpoint ID and API key', 'error');
                return;
            }

            // Construct RunPod URL (async with polling)
            const endpoint = `https://api.runpod.ai/v2/${endpointId}/run`;

            // Build request based on workflow
            let requestBody;

            try {
                if (workflow === 'txt2img') {
                    const prompt = document.getElementById('prompt-txt2img').value.trim();
                    const width = parseInt(document.getElementById('width-txt2img').value);
                    const height = parseInt(document.getElementById('height-txt2img').value);
                    const steps = parseInt(document.getElementById('steps-txt2img').value);
                    const guidance = parseFloat(document.getElementById('guidance-txt2img').value);
                    const seedInput = document.getElementById('seed-txt2img').value;
                    const seed = seedInput ? parseInt(seedInput) : Math.floor(Math.random() * 2147483647);

                    if (!prompt) {
                        showStatus('‚ùå Please enter a prompt', 'error');
                        return;
                    }

                    requestBody = {
                        input: {
                            prompt,
                            width,
                            height,
                            num_inference_steps: steps,
                            guidance_scale: guidance,
                            seed
                        }
                    };
                }
                else if (workflow === 'img2img') {
                    const imageFile = document.getElementById('init-image').files[0];
                    if (!imageFile) {
                        showStatus('‚ùå Please upload an initial image', 'error');
                        return;
                    }

                    const prompt = document.getElementById('prompt-img2img').value.trim();
                    const width = parseInt(document.getElementById('width-img2img').value);
                    const height = parseInt(document.getElementById('height-img2img').value);
                    const strength = parseFloat(document.getElementById('strength-img2img').value);
                    const steps = parseInt(document.getElementById('steps-img2img').value);
                    const guidance = parseFloat(document.getElementById('guidance-img2img').value);
                    const seedInput = document.getElementById('seed-img2img').value;
                    const seed = seedInput ? parseInt(seedInput) : Math.floor(Math.random() * 2147483647);

                    const initImageBase64 = await fileToBase64(imageFile);

                    requestBody = {
                        input: {
                            prompt,
                            init_image: initImageBase64,
                            width,
                            height,
                            strength,
                            num_inference_steps: steps,
                            guidance_scale: guidance,
                            seed
                        }
                    };
                }
                else if (workflow === 'multi') {
                    const image1 = document.getElementById('ref-image-1').files[0];
                    const image2 = document.getElementById('ref-image-2').files[0];
                    const image3 = document.getElementById('ref-image-3').files[0];

                    if (!image1 || !image2) {
                        showStatus('‚ùå Please upload at least 2 reference images', 'error');
                        return;
                    }

                    const prompt = document.getElementById('prompt-multi').value.trim();
                    const width = parseInt(document.getElementById('width-multi').value);
                    const height = parseInt(document.getElementById('height-multi').value);
                    const steps = parseInt(document.getElementById('steps-multi').value);
                    const guidance = parseFloat(document.getElementById('guidance-multi').value);
                    const seedInput = document.getElementById('seed-multi').value;
                    const seed = seedInput ? parseInt(seedInput) : Math.floor(Math.random() * 2147483647);

                    const images = [await fileToBase64(image1), await fileToBase64(image2)];
                    const weights = [0.5, 0.5];

                    if (image3) {
                        images.push(await fileToBase64(image3));
                        weights[0] = 0.4;
                        weights[1] = 0.3;
                        weights[2] = 0.3;
                    }

                    requestBody = {
                        input: {
                            prompt,
                            reference_images: images,
                            reference_weights: weights,
                            width,
                            height,
                            num_inference_steps: steps,
                            guidance_scale: guidance,
                            seed
                        }
                    };
                }

                // Display request
                const requestDisplay = document.getElementById('requestDisplay');
                const displayRequest = JSON.parse(JSON.stringify(requestBody));
                // Truncate base64 for display
                if (displayRequest.input.init_image) {
                    displayRequest.input.init_image = displayRequest.input.init_image.substring(0, 50) + '...';
                }
                if (displayRequest.input.reference_images) {
                    displayRequest.input.reference_images = displayRequest.input.reference_images.map(img => img.substring(0, 50) + '...');
                }
                requestDisplay.textContent = 'üì§ REQUEST:\n\n' + JSON.stringify(displayRequest, null, 2);

                // Hide results, show status
                resultDiv.classList.remove('show');
                requestDiv.classList.add('show');
                showStatus('üé® Sending request to FLUX.2...', 'info');

                // Send request (async)
                showStatus('üì§ Submitting job...', 'info');

                let response;
                try {
                    response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                } catch (fetchError) {
                    console.error('Fetch error details:', fetchError);
                    let errorMsg = '‚ùå Network Error:\n\n';
                    errorMsg += `Error: ${fetchError.message}\n\n`;
                    errorMsg += 'Common causes:\n';
                    errorMsg += '1. Endpoint ID is incorrect\n';
                    errorMsg += '2. Endpoint is paused or not running\n';
                    errorMsg += '3. API key is invalid\n';
                    errorMsg += '4. Network/firewall blocking request\n\n';
                    errorMsg += 'Solutions:\n';
                    errorMsg += `‚Ä¢ Check endpoint ID (currently: ${endpointId})\n`;
                    errorMsg += '‚Ä¢ Verify endpoint is "Running" in RunPod dashboard\n';
                    throw new Error(errorMsg);
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n\nResponse: ${errorText}`);
                }

                const submitResult = await response.json();
                if (!submitResult.id) {
                    throw new Error('No job ID returned from submission');
                }

                const jobId = submitResult.id;
                console.log('Job submitted:', jobId);

                // Poll for results
                showStatus(`‚è≥ Job submitted: ${jobId}`, 'info');

                let attempts = 0;
                const maxAttempts = 300; // 5 minutes max (300 * 1 second)
                let result;

                while (attempts < maxAttempts) {
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second

                    const statusResponse = await fetch(`https://api.runpod.ai/v2/${endpointId}/status/${jobId}`, {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });

                    result = await statusResponse.json();

                    if (result.status === 'IN_QUEUE') {
                        showStatus(`‚è≥ In queue... (${attempts}s)`, 'info');
                    } else if (result.status === 'IN_PROGRESS') {
                        showStatus(`üé® Generating... (${attempts}s)`, 'info');
                    } else if (result.status === 'COMPLETED') {
                        showStatus('‚úÖ Generation complete!', 'success');
                        break;
                    } else if (result.status === 'FAILED') {
                        throw new Error(result.error || 'Job failed');
                    } else if (result.status === 'CANCELLED') {
                        throw new Error('Job was cancelled');
                    }
                }

                if (attempts >= maxAttempts) {
                    throw new Error('Timeout: Job did not complete within 5 minutes');
                }

                console.log('=== COMPLETED RESPONSE ===');
                console.log(JSON.stringify(result, null, 2));
                console.log('==========================');

                // Extract results from completed job
                let images = result.output?.images || [];
                let metadata = result.output?.metadata || {};

                console.log('Extracted images:', images.length);
                console.log('Extracted metadata:', metadata);

                if (images.length === 0) {
                    throw new Error('No images returned from API');
                }

                // Display image
                const img = document.getElementById('generatedImage');
                img.src = `data:image/png;base64,${images[0]}`;

                // Display metadata
                const metadataDiv = document.getElementById('metadata');
                metadataDiv.innerHTML = `
                    <p><strong>üéØ Workflow:</strong> ${workflow}</p>
                    <p><strong>ü§ñ Model:</strong> ${metadata.model || 'FLUX.2-dev'}</p>
                    <p><strong>üìù Prompt:</strong> ${metadata.prompt || requestBody.input.prompt}</p>
                    <p><strong>üìê Dimensions:</strong> ${metadata.width || requestBody.input.width}x${metadata.height || requestBody.input.height}</p>
                    <p><strong>üî¢ Steps:</strong> ${metadata.num_inference_steps || requestBody.input.num_inference_steps}</p>
                    <p><strong>üéöÔ∏è Guidance:</strong> ${metadata.guidance_scale || requestBody.input.guidance_scale}</p>
                    <p><strong>üé≤ Seed:</strong> ${metadata.seed || requestBody.input.seed}</p>
                    <p><strong>‚è±Ô∏è Inference Time:</strong> ${metadata.inference_time ? metadata.inference_time.toFixed(2) + 's' : 'N/A'}</p>
                    ${workflow === 'img2img' ? `<p><strong>üí™ Strength:</strong> ${requestBody.input.strength}</p>` : ''}
                    ${workflow === 'multi' ? `<p><strong>üé≠ References:</strong> ${requestBody.input.reference_images.length} images</p>` : ''}
                `;

                // Update request display with response
                requestDisplay.textContent += '\n\nüì• RESPONSE:\n\n' + JSON.stringify({
                    status: result.status,
                    output: {
                        status: 'success',
                        workflow: workflow,
                        images: ['<base64_image_data>'],
                        metadata: metadata
                    }
                }, null, 2);

                resultDiv.classList.add('show');
                showStatus('‚úÖ Image generated successfully!', 'success');

            } catch (error) {
                console.error('Generation error:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');

                // Show error in request display
                const requestDisplay = document.getElementById('requestDisplay');
                requestDisplay.textContent += '\n\n‚ùå ERROR:\n\n' + error.message;
                requestDiv.classList.add('show');
            }
        }

        // Test connection to endpoint
        async function testConnection() {
            const endpointId = document.getElementById('endpointId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!endpointId) {
                showStatus('‚ùå Please enter endpoint ID', 'error');
                return;
            }

            if (!apiKey) {
                showStatus('‚ùå Please enter API key', 'error');
                return;
            }

            // Construct RunPod URL (async with polling)
            const endpoint = `https://api.runpod.ai/v2/${endpointId}/run`;

            showStatus('üîç Testing connection...', 'info');

            try {
                // Send a minimal test request
                const testRequest = {
                    input: {
                        prompt: "test connection",
                        width: 512,
                        height: 512,
                        num_inference_steps: 1,
                        guidance_scale: 1.0
                    }
                };

                console.log('Testing endpoint:', endpoint);
                console.log('Test request:', testRequest);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(testRequest)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\n\n${errorText}`);
                }

                const result = await response.json();
                console.log('Response:', result);

                if (result.id) {
                    showStatus(`‚úÖ Connection successful! Job submitted: ${result.id}`, 'success');
                } else {
                    showStatus('‚úÖ Connection successful! Endpoint is reachable and API key is valid.', 'success');
                }

            } catch (error) {
                console.error('Connection test failed:', error);

                let errorMsg = '‚ùå Connection Test Failed\n\n';
                errorMsg += `Error: ${error.message}\n\n`;

                if (error.message.includes('Failed to fetch') || error.message === 'Network request failed') {
                    errorMsg += 'üìç Troubleshooting Steps:\n\n';
                    errorMsg += '1. Check endpoint ID:\n';
                    errorMsg += `   ‚Ä¢ Your endpoint ID: ${endpointId}\n`;
                    errorMsg += `   ‚Ä¢ Constructed URL: ${endpoint}\n\n`;
                    errorMsg += '2. Verify endpoint status in RunPod dashboard:\n';
                    errorMsg += '   ‚Ä¢ Status must be "Running" (not "Paused")\n';
                    errorMsg += '   ‚Ä¢ Check Workers > Your Endpoint\n\n';
                    errorMsg += '3. Test with curl command:\n\n';
                    errorMsg += 'curl -X POST "' + endpoint + '" \\\n';
                    errorMsg += '  -H "Content-Type: application/json" \\\n';
                    errorMsg += '  -H "Authorization: Bearer ' + apiKey.substring(0, 10) + '..." \\\n';
                    errorMsg += '  -d \'{"input": {"prompt": "test", "width": 512, "height": 512, "num_inference_steps": 1}}\'\n\n';
                    errorMsg += '4. Common issues:\n';
                    errorMsg += '   ‚Ä¢ Wrong endpoint ID\n';
                    errorMsg += '   ‚Ä¢ Endpoint is initializing (wait 1-2 minutes)\n';
                    errorMsg += '   ‚Ä¢ API key typo or spaces\n';
                    errorMsg += '   ‚Ä¢ Firewall/VPN blocking request\n';
                } else if (error.message.includes('401')) {
                    errorMsg += 'üîë Authentication Issue:\n';
                    errorMsg += '‚Ä¢ API key is invalid or expired\n';
                    errorMsg += '‚Ä¢ Get new key: RunPod Dashboard ‚Üí Settings ‚Üí API Keys\n';
                } else if (error.message.includes('404')) {
                    errorMsg += 'üîç Endpoint Not Found:\n';
                    errorMsg += '‚Ä¢ Check endpoint ID in URL\n';
                    errorMsg += '‚Ä¢ Format: https://api.runpod.ai/v2/{ENDPOINT_ID}/runsync\n';
                }

                showStatus(errorMsg, 'error');
            }
        }

        // Initialize random seeds on page load
        window.onload = () => {
            randomizeSeed('txt2img');
            randomizeSeed('img2img');
            randomizeSeed('multi');
        };
    </script>

</body>
</html>
